version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.corregido
    container_name: cps_app
    ports:
      - "80:80"
    volumes:
      - .:/var/www
    environment:
      # Variables de entorno de EasyPanel
      - EASYPANEL=true
      - APP_ENV=production
      - APP_DEBUG=false
      # Variables específicas de CPS
      - APP_NAME=CPS
      - APP_LICENSE=${APP_LICENSE:-licensing_YMks1531pjbNIndSEobc}
      - API_TOKEN=${API_TOKEN:-31535385afb2c62faa927f42ea346f04}
      - APP_VERSION=120.55.1
      # Variables de email
      - MAIL_HOST=${MAIL_HOST:-smtp.tu-proveedor-email.com}
      - MAIL_USERNAME=${MAIL_USERNAME:-tu-email@dominio.com}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-tu_password_email}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@localhost}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-"CPS System"}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - cps_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  mysql:
    image: mysql:8.0
    container_name: cps_mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-cps_password_123}
      MYSQL_DATABASE: ${DB_DATABASE:-cps_database}
      MYSQL_USER: ${DB_USERNAME:-cps_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-cps_password_123}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
    ports:
      - "3306:3306"
    networks:
      - cps_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD:-cps_password_123}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: cps_redis
    volumes:
      - redis_data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - "6379:6379"
    networks:
      - cps_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: cps_phpmyadmin
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_ARBITRARY: 1
      UPLOAD_MAX_FILESIZE: 64M
      POST_MAX_SIZE: 64M
    ports:
      - "8080:80"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - cps_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis-insight:
    image: redislabs/redisinsight:latest
    container_name: cps_redis_insight
    ports:
      - "8001:8001"
    volumes:
      - redis_insight_data:/db
    networks:
      - cps_network
    restart: unless-stopped

  # Servicio de monitoreo
  monitor:
    image: nginx:alpine
    container_name: cps_monitor
    ports:
      - "8002:80"
    volumes:
      - ./docker/nginx/monitor.conf:/etc/nginx/conf.d/default.conf:ro
      - ./public:/usr/share/nginx/html:ro
    networks:
      - cps_network
    restart: unless-stopped

networks:
  cps_network:
    driver: bridge
    name: cps_network
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.driver.mtu: "1500"

volumes:
  mysql_data:
    driver: local
    name: cps_mysql_data
  redis_data:
    driver: local
    name: cps_redis_data
  redis_insight_data:
    driver: local
    name: cps_redis_insight_data

# ==============================================================================
# CONFIGURACIONES ESPECÍFICAS PARA CPS EN EASYPANEL
# ==============================================================================

# Variables de entorno que deben configurarse:
# APP_LICENSE=licensing_YMks1531pjbNIndSEobc
# API_TOKEN=31535385afb2c62faa927f42ea346f04
# MAIL_HOST=smtp.tu-proveedor-email.com
# MAIL_USERNAME=tu-email@dominio.com
# MAIL_PASSWORD=tu_password_email

# Puertos expuestos:
# - 80: Aplicación CPS
# - 3306: MySQL (solo para desarrollo)
# - 6379: Redis (solo para desarrollo)
# - 8080: phpMyAdmin
# - 8001: Redis Insight
# - 8002: Monitor del sistema

# Mejoras implementadas:
# 1. Dockerfile corregido que soluciona todos los errores
# 2. Health checks para servicios
# 3. Variables de entorno optimizadas
# 4. Reinicio automático de contenedores
# 5. Monitoreo de la aplicación
# 6. Configuraciones de producción
# ==============================================================================